<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Resultados ‚Äî Estival 2025‚Äì2026</title>
  <meta name="theme-color" content="#000000" />
  <meta name="description" content="Resultados oficiales para el p√∫blico ‚Äî Estival de Midgets 2025‚Äì26" />
  <style>
    :root{
      --bg: #0b0b0b;
      --bg-soft: #121212;
      --card: #161616;
      --muted: #999;
      --text: #f2f2f2;
      --accent: #ff7a1a; /* naranja intenso */
      --accent-2: #ffc49a; /* naranja pastel */
      --ok: #26d07c;
      --bad: #ff5a5f;
      --table-stripe: rgba(255,255,255,0.03);
      --shadow: 0 6px 24px rgba(0,0,0,.4);
      --radius: 16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Noto Sans", "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: radial-gradient(1200px 600px at 10% 0%, rgba(255,122,26,.12), transparent 40%),
                  radial-gradient(900px 500px at 90% 0%, rgba(255,196,154,.08), transparent 40%),
                  var(--bg);
      color:var(--text);
    }
    header{
      position:sticky; top:0; z-index:10; backdrop-filter: blur(6px);
      background: linear-gradient(180deg, rgba(0,0,0,.75), rgba(0,0,0,.3));
      border-bottom: 1px solid rgba(255,255,255,.06);
    }
    .wrap{max-width:1100px; margin:0 auto; padding: 16px 20px}
    h1{margin:8px 0 4px; font-size: clamp(22px, 3vw, 32px); letter-spacing:.5px}
    .season{color:var(--accent-2); font-weight:600}
    .toolbar{display:flex; gap:12px; flex-wrap:wrap; align-items:center; margin:10px 0}
    select, button, input[type="search"]{
      background: var(--card); color: var(--text); border:1px solid rgba(255,255,255,.08);
      padding:10px 12px; border-radius: 12px; outline: none;
    }
    button{ cursor:pointer; box-shadow: var(--shadow); transition: transform .08s ease}
    button:hover{ transform: translateY(-1px)}
    .btn-primary{ background: linear-gradient(180deg, var(--accent), #e06000); border: none; color:#111; font-weight:700}
    .btn-ghost{ background: var(--bg-soft)}

    main{max-width:1100px; margin: 18px auto; display: grid; gap: 18px; grid-template-columns: 320px 1fr; padding: 0 20px}
    @media (max-width: 900px){ main{ grid-template-columns: 1fr }}

    .card{ background: var(--card); border:1px solid rgba(255,255,255,.06); border-radius: var(--radius); box-shadow: var(--shadow)}
    .card h2{ font-size: 18px; margin:0 0 8px; color:var(--accent-2); letter-spacing:.4px}
    .card .content{ padding: 14px }

    /* Lista de carreras */
    .race-list{ list-style:none; padding:0; margin:0; display:flex; flex-direction:column; gap:6px }
    .race-item{ display:flex; justify-content:space-between; align-items:center; gap:10px; padding:10px 12px; border-radius:12px; background:var(--bg-soft); border:1px solid rgba(255,255,255,.06)}
    .race-item button{ margin-left:auto }

    /* Resultados */
    .table-wrap{ overflow:auto; border-radius: 14px; border:1px solid rgba(255,255,255,.08); background: var(--bg-soft)}
    table{ width:100%; border-collapse: collapse; min-width:680px}
    thead th{ position:sticky; top:0; background: #0e0e0e; z-index:1; font-weight:700; text-align:left; padding:10px; font-size:13px; border-bottom:1px solid rgba(255,255,255,.12)}
    tbody td{ padding:10px; border-bottom:1px solid rgba(255,255,255,.06); font-size:14px}
    tbody tr:nth-child(odd){ background: var(--table-stripe)}
    .pos{ width:60px }
    .num{ width:70px }
    .laps{ width:80px }
    .pen{ width:120px }
    .note{ color:var(--muted); font-size:13px }
    .muted{ color:var(--muted)}

    .footer{
      text-align:center; color:var(--muted); font-size:12px; padding:14px 0 30px
    }
    .footer a{ color:var(--muted); text-decoration:none }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>üèÅ Resultados ‚Äî <span class="season">Estival 2025‚Äì26</span></h1>
      <div class="toolbar">
        <label for="fechaSelect" class="muted">Fecha:</label>
        <select id="fechaSelect" aria-label="Seleccionar fecha"></select>
        <button id="btnCargar" class="btn-primary">Cargar carreras</button>
        <input id="buscador" type="search" placeholder="Buscar piloto o N¬∞" />
        <button id="btnActualizar" class="btn-ghost" title="Forzar actualizaci√≥n">Actualizar datos</button>
        <button id="btnCompartir" class="btn-ghost" title="Compartir vista">Compartir</button>
      </div>
    </div>
  </header>

  <main>
    <section class="card">
      <div class="content">
        <h2>Carreras disponibles</h2>
        <ul id="raceList" class="race-list"></ul>
      </div>
    </section>

    <section class="card">
      <div class="content">
        <h2 id="tituloResultados">Resultados</h2>
        <div class="table-wrap">
          <table id="tabla">
            <thead>
              <tr>
                <th class="pos">Pos.</th>
                <th class="num">N¬∞</th>
                <th>Nombre</th>
                <th>Tiempo</th>
                <th>T. Final</th>
                <th class="laps">Vueltas</th>
                <th class="pen">Penalizaci√≥n</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
        <div id="estado" class="muted" style="margin-top:8px"></div>
      </div>
    </section>
  </main>

  <div class="footer">
    <a href="https://www.primate.com.ar" target="_blank">by PRIMATE ¬Æ</a>
  </div>

  <script>
    // === CONFIGURACI√ìN ===
    // 1) Ruta RAW de GitHub (o de tu hosting) con los JSON generados por process_pdfs
    //    Estructura esperada: {BASE}/Fecha 1/serie1.json, ...
    const DATA_BASE = "https://raw.githubusercontent.com/jcheva123/showmidget/main/resultados"; // ‚Üê cambi√° si fuera otro repo/rama

    // 2) Ramas de carreras a testear (se intenta en orden)
    const CANDIDATES = [
      // Series (m√°s de 10 por si acaso)
      ...Array.from({length: 16}, (_,i)=>`serie${i+1}`),
      // Repechajes
      ...Array.from({length: 4}, (_,i)=>`repechaje${i+1}`),
      // Semifinales
      ...Array.from({length: 6}, (_,i)=>`semifinal${i+1}`),
      // Prefinal + Final
      "prefinal", "final"
    ];

    // Cache simple
    const cache = {
      get(key){ try{ return JSON.parse(localStorage.getItem(key) || "null") }catch{ return null } },
      set(key,val){ localStorage.setItem(key, JSON.stringify(val)) },
      clear(){ localStorage.clear() }
    };

    const qs = new URLSearchParams(location.search);

    const fechaSelect = document.getElementById('fechaSelect');
    const raceList = document.getElementById('raceList');
    const tbody = document.getElementById('tbody');
    const estado = document.getElementById('estado');
    const tituloResultados = document.getElementById('tituloResultados');

    document.getElementById('btnActualizar').onclick = ()=>{ cache.clear(); location.reload() };
    document.getElementById('btnCargar').onclick = loadRaces;
    document.getElementById('btnCompartir').onclick = compartirVista;
    document.getElementById('buscador').addEventListener('input', filtrarTabla);

    init();

    async function init(){
      await poblarFechas();
      // Preselecci√≥n por URL
      const f = qs.get('fecha');
      if (f){ sel(fechaSelect, f) }
      await loadRaces();
      const c = qs.get('carrera');
      if (c){
        const btn = document.querySelector(`[data-carrera="${c}"]`);
        if (btn) btn.click();
      }
    }

    function sel(select, value){
      const opt = Array.from(select.options).find(o => o.value === value);
      if (opt) select.value = value;
    }

    async function poblarFechas(){
      // Intentamos listar directorios reales en GitHub (contents API). Si falla, caemos a 1..18.
      const api = DATA_BASE
        .replace('https://raw.githubusercontent.com/','https://api.github.com/repos/')
        .replace('/main/','/contents/');
      let fechas = [];
      try{
        const r = await fetch(api);
        if (r.ok){
          const arr = await r.json();
          fechas = arr.filter(x => x.type === 'dir' && x.name.toLowerCase().startsWith('fecha'))
                      .map(x => x.name)
                      .sort((a,b)=> num(a)-num(b));
        }
      }catch{}
      if (fechas.length === 0){
        // predeterminado
        fechas = Array.from({length: 18}, (_,i)=>`Fecha ${i+1}`);
      }
      fechaSelect.innerHTML = fechas.map(f => `<option value="${f}">${f}</option>`).join('');
      // Si no ven√≠a por URL, seteamos la √∫ltima
      if (!qs.get('fecha')) fechaSelect.value = fechas[fechas.length-1];
    }

    function num(fechaName){
      const m = fechaName.match(/(\d+)/); return m? Number(m[1]) : 0;
    }

    async function loadRaces(){
      const fecha = fechaSelect.value;
      raceList.innerHTML = '<li class="muted">Buscando carreras‚Ä¶</li>';
      const races = await probeRaces(fecha);
      if (races.length === 0){
        raceList.innerHTML = '<li class="muted">No encontr√© carreras para esta fecha.</li>';
        tbody.innerHTML = '';
        tituloResultados.textContent = 'Resultados';
        estado.textContent = '';
        return;
      }
      raceList.innerHTML = '';
      for (const r of races){
        const li = document.createElement('li');
        li.className = 'race-item';
        li.innerHTML = `<span>${labelCarrera(r)}</span>`;
        const btn = document.createElement('button');
        btn.className = 'btn-primary';
        btn.textContent = 'Ver';
        btn.dataset.carrera = r;
        btn.onclick = ()=> loadTable(fecha, r);
        li.appendChild(btn);
        raceList.appendChild(li);
      }
      // Si hay una sola, la cargamos
      if (races.length === 1) loadTable(fecha, races[0]);
    }

    function labelCarrera(c){
      const cap = (s)=> s.charAt(0).toUpperCase() + s.slice(1);
      const m = c.match(/([a-zA-Z]+)(\d+)?/);
      if (!m) return cap(c);
      const nombre = m[1]; const n = m[2];
      const map = { serie: 'Serie', repechaje: 'Repechaje', semifinal: 'Semifinal', prefinal: 'Prefinal', final: 'Final' };
      return map[nombre] ? `${map[nombre]}${n? ' ' + n: ''}` : cap(c);
    }

    async function probeRaces(fecha){
      const found = [];
      // Prob√° primero si hay un index.json con el listado de carreras (opcional)
      try{
        const idxUrl = `${DATA_BASE}/${encodeURIComponent(fecha)}/index.json`;
        const ir = await fetch(idxUrl);
        if (ir.ok){
          const idx = await ir.json();
          if (Array.isArray(idx.races)){
            return idx.races.map(String);
          }
        }
      }catch{}

      // Sino, probamos candidatos individuales
      await Promise.all(CANDIDATES.map(async (name) => {
        const url = `${DATA_BASE}/${encodeURIComponent(fecha)}/${name}.json`;
        const k = `res:${fecha}:${name}`;
        const cached = cache.get(k);
        if (cached && cached.__ok){ found.push(name); return }
        try{
          const r = await fetch(url, { cache: 'no-store' });
          if (r.ok){
            const j = await r.json();
            cache.set(k, {__ok:true, j, t:Date.now()});
            found.push(name);
          }
        }catch{}
      }));
      return found;
    }

    function filtrarTabla(e){
      const q = e.target.value.toLowerCase();
      const rows = Array.from(tbody.querySelectorAll('tr'));
      rows.forEach(tr => {
        const txt = tr.textContent.toLowerCase();
        tr.style.display = txt.includes(q) ? '' : 'none';
      });
    }

    async function loadTable(fecha, carrera){
      const k = `res:${fecha}:${carrera}`;
      let data = cache.get(k);
      let fromCache = !!data;
      if (!data){
        const url = `${DATA_BASE}/${encodeURIComponent(fecha)}/${carrera}.json`;
        const r = await fetch(url, { cache: 'no-store' });
        if (!r.ok){ estado.textContent = 'No se pudo cargar la carrera.'; return }
        const j = await r.json();
        data = { __ok:true, j, t:Date.now() };
        cache.set(k, data);
        fromCache = false;
      }
      const j = data.j;
      renderTable(j.results || [], { fecha: j.date || fecha, hora: j.time || null, carrera });
      if (fromCache){ estado.textContent = 'Mostrando versi√≥n en cach√©. Us√° ‚ÄúActualizar datos‚Äù.' }
      else { estado.textContent = '' }
      // actualizar URL
      const url = new URL(location.href);
      url.searchParams.set('fecha', fecha);
      url.searchParams.set('carrera', carrera);
      history.replaceState(null, '', url.toString());
    }

    function renderTable(rows, meta){
      tituloResultados.textContent = `${labelCarrera(meta.carrera)}${meta.fecha? ' ‚Äî ' + meta.fecha: ''}${meta.hora? ' ¬∑ ' + meta.hora: ''}`;
      tbody.innerHTML = rows.map(r => {
        const penNote = r.penalty_note ? ` <span class="note">(${escapeHtml(r.penalty_note)})</span>` : '';
        const pen = (r.penalty ?? 0);
        return `<tr>
          <td class="pos">${r.position ?? ''}</td>
          <td class="num">${r.number ?? ''}</td>
          <td>${escapeHtml(r.name || '')}</td>
          <td>${r.rec_str || secsToStr(r.rec) || ''}</td>
          <td>${r.t_final || ''}</td>
          <td class="laps">${r.laps ?? ''}</td>
          <td class="pen">${pen}${penNote}</td>
        </tr>`
      }).join('');
    }

    function secsToStr(s){ if (s == null) return null; const m = Math.floor(s/60); const ss = (s - m*60).toFixed(3).padStart(6,'0'); return `${m}:${ss}` }
    function escapeHtml(s){ return s.replace(/[&<>\"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])) }

    async function compartirVista(){
      const url = new URL(location.href);
      try{
        await navigator.clipboard.writeText(url.toString());
        estado.textContent = 'Enlace copiado';
        setTimeout(()=> estado.textContent = '', 1500);
      }catch{
        alert(url.toString());
      }
    }
  </script>
</body>
</html>
